name: Unit Tests with Allure Report

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lab3/code/**'

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image with Allure
      run: docker build -t bd-unit-tests .
      
    - name: Run tests with TRX output
      run: |
        mkdir -p test-results
        docker run --rm -v $(pwd)/test-results:/test-results bd-unit-tests

    - name: Convert TRX to Allure
      run: |
        pip install trx2allure
        trx2allure test-results/test_results.trx allure-results

    - name: Generate Allure report
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre
        curl -o allure-2.27.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
        tar -zxvf allure-2.27.0.tgz
        ./allure-2.27.0/bin/allure generate allure-results -o allure-report --clean

    - name: Upload Allure report
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 7

