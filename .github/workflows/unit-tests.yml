name: Unit Tests with Report

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lab3/code/**'

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      run: docker build -t bd-unit-tests -f Dockerfile.unit .
      
    - name: Run unit tests with HTML output
      run: |
        mkdir -p test-results
        docker run --rm -v $(pwd)/test-results:/test-results bd-unit-tests --logger "html;LogFileName=/test-results/unit-report.html"

    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-report
        path: test-results/unit-report.html
        retention-days: 2

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests  # Запускаем только после успешных unit-тестов
    if: success()  # Только если предыдущий job успешен

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build integration test image
      run: docker build -t bd-integration-tests -f Dockerfile.integration .

    - name: Wait for PostgreSQL to be ready
      run: |
        echo "Waiting for PostgreSQL to start..."
        for i in {1..30}; do
          if nc -z localhost 5432; then
            echo "PostgreSQL is ready!"
            exit 0
          fi
          echo "Waiting for PostgreSQL... Attempt $i/30"
          sleep 2
        done
        echo "PostgreSQL failed to start within 60 seconds"
        exit 1

    - name: Run integration tests with HTML output
      run: |
        mkdir -p test-results
        docker run --rm \
          --network host \
          -e ConnectionStrings__TestDbConnection="Host=localhost;Port=5432;Database=testdb;Username=postgres;Password=postgres" \
          -v $(pwd)/test-results:/test-results \
          bd-integration-tests \
          --logger "html;LogFileName=/test-results/integration-report.html"

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-report
        path: test-results/integration-report.html
        retention-days: 2

    - name: Upload test results even on failure
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-report-on-failure
        path: test-results/integration-report.html
        retention-days: 2